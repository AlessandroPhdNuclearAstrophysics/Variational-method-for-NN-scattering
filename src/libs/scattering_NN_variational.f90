MODULE SCATTERING_NN_VARIATIONAL
  IMPLICIT NONE
  PRIVATE

  INTEGER, PARAMETER :: NNE = 80
  INTEGER, PARAMETER :: NCH_MAX = 2
  INTEGER, PARAMETER :: NNN = NNE * 2
  INTEGER, PARAMETER :: NNR = 1000
  INTEGER :: NCH
  INTEGER :: NDIM ! GIVEN BY CORE_CORE_MATRIX_ELEMENTS
  INTEGER :: NEQ  ! GIVEN BY ASYMPTOTIC_ASYMPTOTIC_MATRIX_ELEMENTS

  DOUBLE PRECISION, PARAMETER :: HC = 197.327053D0
  DOUBLE PRECISION, PARAMETER :: MP = 938.272029D0
  DOUBLE PRECISION, PARAMETER :: MN = 939.565630D0
  DOUBLE PRECISION, PARAMETER :: MR = MP * MN / (MP + MN)
  DOUBLE PRECISION, PARAMETER :: PI = 4*DATAN(1.0D0)
  COMPLEX*16, PARAMETER ::       IM = (0.0D0, 1.0D0)
  DOUBLE PRECISION, PARAMETER :: ONE = 1.0D0, ZERO = 0.0D0

  DOUBLE PRECISION :: K, HTM, M
  INTEGER :: LC(NCH_MAX), T

  TYPE, PUBLIC :: VARIATIONAL_PARAMETERS
    INTEGER :: J, L, S, TZ, IPOT, ILB, LEMP
    LOGICAL :: VCOUL
    DOUBLE PRECISION :: E
  END TYPE VARIATIONAL_PARAMETERS

  TYPE(VARIATIONAL_PARAMETERS), PRIVATE :: VARIATIONAL_PARAMS

  PUBLIC :: SET_VARIATIONAL_PARAMETERS
  PUBLIC :: NN_SCATTERING_VARIATIONAL

CONTAINS
  SUBROUTINE SET_VARIATIONAL_PARAMETERS(E, J, L, S, TZ, IPOT, ILB, LEMP, VCOUL)
    IMPLICIT NONE
    DOUBLE PRECISION, INTENT(IN) :: E
    INTEGER, INTENT(IN) :: J, L, S, TZ, IPOT, ILB, LEMP
    LOGICAL, INTENT(IN) :: VCOUL

    VARIATIONAL_PARAMS%J = J
    VARIATIONAL_PARAMS%L = L
    VARIATIONAL_PARAMS%S = S
    VARIATIONAL_PARAMS%TZ = TZ
    VARIATIONAL_PARAMS%IPOT = IPOT
    VARIATIONAL_PARAMS%ILB = ILB
    VARIATIONAL_PARAMS%LEMP = LEMP
    VARIATIONAL_PARAMS%E = E
    VARIATIONAL_PARAMS%VCOUL = VCOUL
    
    SELECT CASE (TZ)
      CASE (1)
        M = MP
      CASE (0)
        M = MP * MN / (MP + MN)
      CASE (-1)
        M = MN
      CASE DEFAULT
        PRINT *, "Invalid TZ value"
        STOP
    END SELECT

    HTM = HC**2 / (2 * M)

  ! Ensure T is set such that T + L + S is odd
    IF (MOD(L + S, 2) == 0) THEN
      T = 1
    ELSE
      T = 0
    END IF

    K = DSQRT(2*E*MR) / HC

    PRINT 5
    PRINT 15, "L", "S", "T", "TZ", "J"
    PRINT 5
    LC(1) = L
    NCH = 1
    PRINT 20, LC(1), S, T, TZ, J
    IF (J-L.EQ.1) THEN 
      LC(2) = L + 2
      PRINT 20, LC(2), S, T, TZ, J
      NCH = 2
    ENDIF
    PRINT 5


  5 FORMAT(30("-"))
 15 FORMAT(" ", A5, A5, A5, A5, A5, A5)
 20 FORMAT(" ", I5, I5, I5, I5, I5, I5)
  END SUBROUTINE SET_VARIATIONAL_PARAMETERS
  

  ! This subroutine calculates the NN scattering using a variational method
  ! INPUT PARAMETERS:
  ! E     : Energy in MeV
  ! J     : Total angular momentum
  ! L     : Orbital angular momentum
  ! S     : Spin
  ! TZ    : Isospin projection
  ! IPOT  : Potential type
  ! ILB   : Interaction type
  ! LEMP  : Orbital angular momentum of the last particle
  ! VCOUL: Coulomb potential flag
SUBROUTINE NN_SCATTERING_VARIATIONAL(E, J, L, S, TZ, IPOT, ILB, LEMP, VCOUL)
  IMPLICIT NONE
! INPUT PARAMETERS
  DOUBLE PRECISION, INTENT(IN) :: E
  INTEGER, INTENT(IN) :: J, L, S, TZ, IPOT, ILB, LEMP
  LOGICAL, INTENT(IN) :: VCOUL

! VARIABLES AND PARAMETERS FOR DGESV
  DOUBLE PRECISION, DIMENSION(NNN, NNN) :: C, CC, CCC
  DOUBLE PRECISION, DIMENSION(NNN, NNN) :: CAR, CARR, CAI, CAII
  DOUBLE PRECISION, DIMENSION(NCH_MAX, NNN) :: XRCOEFF, XICOEFF
  DOUBLE PRECISION, DIMENSION(NNN, NNN) :: IPIV
  INTEGER :: INFO

! MATRICES FOR THE VARIATIONAL METHOD
  DOUBLE PRECISION, DIMENSION(NNN, NNN) :: AMM, ANN
  DOUBLE PRECISION, DIMENSION(NNN, NNN) :: AMM2, ANN2
  DOUBLE PRECISION, DIMENSION(NCH_MAX, NCH_MAX) :: ARI, AIR, ARR, AII
  
! INITIALIZE THE VARIATIONAL PARAMETERS
  CALL SET_VARIATIONAL_PARAMETERS(E, J, L, S, TZ, IPOT, ILB, LEMP, VCOUL)

  CALL PRINT_INFO()
  STOP

! Evaluating the matrix elements
  CALL ASYMPTOTIC_CORE_MATRIX_ELEMENTS      (CAR, CAI)
  CALL CORE_CORE_MATRIX_ELEMENTS            (C)
  CALL ASYMPTOTIC_ASYMPTOTIC_MATRIX_ELEMENTS(ARI, AIR, ARR, AII)

! Preparing the matrix elements for the diagonalization


! Solving the eigenvalue problem using LAPACK dgesv
! Evaluating for the "c_{n, alpha}" coefficients
  CALL DGESV(NDIM, 1, CC , NNN, IPIV, CARR, NNN, INFO)
  CALL HANDLE_INFO_ERROR()  ! Handle the error after the first DGESV call
  CALL DGESV(NDIM, 1, CCC, NNN, IPIV, CAII, NNN, INFO)
  CALL HANDLE_INFO_ERROR()  ! Handle the error after the second DGESV call

! Evaluating the "R_{alpha, beta}" matrix elements
  CALL DGESV(NEQ, NEQ, AMM, NCH_MAX, IPIV, ANN, NCH_MAX, INFO)
  CALL HANDLE_INFO_ERROR()  ! Handle the error after the third DGESV call


! Evaluating the "R_{alpha, beta}" matrix elements to the second order



! Calculating the phase shifts and mixing angles







  CONTAINS
    SUBROUTINE HANDLE_INFO_ERROR()
      IMPLICIT NONE
      IF (INFO.NE.0) THEN
        PRINT *, "Error in LAPACK dgesv: INFO = ", INFO
        STOP
      ENDIF
    END SUBROUTINE HANDLE_INFO_ERROR

    SUBROUTINE PRINT_INFO()
      IMPLICIT NONE
      PRINT *, "E:    ",                  VARIATIONAL_PARAMS%E, " MeV"
      PRINT *, "HTM:  ",                  HTM, " MeV fm^2"
      PRINT *, "k:    ",                  K, " fm^-1"
      PRINT 10, "J:     ",                VARIATIONAL_PARAMS%J
      PRINT 10, "NCH:   ",                NCH
      PRINT 10, "L0:    ",                LC(1)
      IF (NCH.EQ.2) PRINT 10, "L1:    ",  LC(2)
      PRINT 10, "S:     ",                VARIATIONAL_PARAMS%S
      PRINT 10, "T:     ",                T
      PRINT 10, "TZ:    ",                VARIATIONAL_PARAMS%TZ

  10 FORMAT(" ",A, I2)
  END SUBROUTINE PRINT_INFO


  END SUBROUTINE NN_SCATTERING_VARIATIONAL



  SUBROUTINE CORE_CORE_MATRIX_ELEMENTS(C)
    IMPLICIT NONE
    DOUBLE PRECISION, DIMENSION(NNN, NNN), INTENT(OUT) :: C


    ! Add the implementation of the core-core matrix elements here

  END SUBROUTINE CORE_CORE_MATRIX_ELEMENTS

  SUBROUTINE ASYMPTOTIC_CORE_MATRIX_ELEMENTS(CAR, CAI)
    USE gsl_coulomb
    IMPLICIT NONE
    DOUBLE PRECISION, DIMENSION(NNN, NCH_MAX), INTENT(OUT) :: CAR, CAI

    ! Add the implementation of the asymptotic core matrix elements here

  END SUBROUTINE ASYMPTOTIC_CORE_MATRIX_ELEMENTS

  SUBROUTINE ASYMPTOTIC_ASYMPTOTIC_MATRIX_ELEMENTS(ARI, AIR, ARR, AII)
    USE gsl_coulomb
    IMPLICIT NONE
    DOUBLE PRECISION, DIMENSION(NCH, NCH), INTENT(OUT) :: ARI, AIR, ARR, AII

    ! Add the implementation of the asymptotic-asymptotic matrix elements here

  END SUBROUTINE ASYMPTOTIC_ASYMPTOTIC_MATRIX_ELEMENTS

END MODULE SCATTERING_NN_VARIATIONAL